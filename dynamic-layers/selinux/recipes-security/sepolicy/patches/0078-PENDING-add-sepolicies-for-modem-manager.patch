From 70f6d1eb875c083cf72152a23383ec3ea5e97c33 Mon Sep 17 00:00:00 2001
From: Kamesh Relangi <quic_krelangi@quicinc.com>
Date: Wed, 25 Sep 2024 15:00:52 +0530
Subject: [PATCH] PENDING: Add sepolicy rules for modem manager

Upstream-Status: Pending

Change-Id: Ic83cb17aeaf63615a4729da63c39953d0fe3ef76
Signed-off-by: Kamesh Relangi <quic_krelangi@quicinc.com>
---
 policy/modules/services/modemmanager.fc |  3 +++
 policy/modules/services/modemmanager.te | 21 ++++++++++++++++++---
 2 files changed, 21 insertions(+), 3 deletions(-)

diff --git a/policy/modules/services/modemmanager.fc b/policy/modules/services/modemmanager.fc
index 88d8ff3f6..26d1830c1 100644
--- a/policy/modules/services/modemmanager.fc
+++ b/policy/modules/services/modemmanager.fc
@@ -3,3 +3,6 @@
 
 /usr/sbin/ModemManager	--	gen_context(system_u:object_r:modemmanager_exec_t,s0)
 /usr/sbin/modem-manager	--	gen_context(system_u:object_r:modemmanager_exec_t,s0)
+/etc/ModemManager(/.*)? --      gen_context(system_u:object_r:modemmanager_etc_t,s0)
+/etc/ModemManager/connection.d   --   gen_context(system_u:object_r:etc_t,s0)
+/etc/ModemManager/fcc-unlock.d   --   gen_context(system_u:object_r:etc_t,s0)
diff --git a/policy/modules/services/modemmanager.te b/policy/modules/services/modemmanager.te
index f21b33c82..3c6fb9bdc 100644
--- a/policy/modules/services/modemmanager.te
+++ b/policy/modules/services/modemmanager.te
@@ -9,6 +9,15 @@ type modemmanager_t;
 type modemmanager_exec_t;
 init_daemon_domain(modemmanager_t, modemmanager_exec_t)
 
+type modemmanager_var_log_t;
+logging_log_file(modemmanager_var_log_t)
+logging_log_filetrans(modemmanager_t, modemmanager_var_log_t, file, "mmlog.txt")
+
+type modemmanager_etc_t;
+files_type(modemmanager_etc_t)
+filetrans_pattern(modemmanager_t, etc_t, modemmanager_etc_t, { dir file })
+files_config_file(modemmanager_etc_t)
+
 ########################################
 #
 # Local policy
@@ -19,9 +28,11 @@ allow modemmanager_t self:process { getsched setpgid setsched signal };
 allow modemmanager_t self:fifo_file rw_fifo_file_perms;
 allow modemmanager_t self:unix_stream_socket { connectto create_stream_socket_perms };
 allow modemmanager_t self:netlink_kobject_uevent_socket create_socket_perms;
-allow modemmanager_t self:netlink_route_socket { create getattr getopt nlmsg_write read write };
+allow modemmanager_t self:netlink_route_socket { create_netlink_socket_perms nlmsg_write read write };
 allow modemmanager_t self:qipcrtr_socket { create getattr getopt read write };
-
+allow modemmanager_t modemmanager_etc_t:dir manage_dir_perms;
+allow modemmanager_t modemmanager_etc_t:file manage_file_perms;
+allow modemmanager_t modemmanager_var_log_t:file manage_file_perms;
 # ModemManager  calls mmap(PROT_READ|PROT_WRITE|PROT_EXEC)
 allow modemmanager_t self:process execmem;
 
@@ -30,7 +41,11 @@ kernel_request_load_module(modemmanager_t)
 
 # for qmi/pass_through
 dev_create_sysfs_files(modemmanager_t)
-
+fs_search_tmpfs(modemmanager_t)
+logging_rw_generic_log_dirs(modemmanager_t)
+logging_dontaudit_write_generic_logs(modemmanager_t)
+corecmd_dontaudit_search_bin(modemmanager_t)
+init_dbus_send_script(modemmanager_t)
 dev_getattr_sysfs(modemmanager_t)
 dev_read_sysfs(modemmanager_t)
 dev_write_sysfs(modemmanager_t)
-- 
2.25.1
